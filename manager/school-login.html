<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <!-- Content Security Policy -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src 'self' data: blob:; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com; script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com; base-uri 'self'; form-action 'self'; frame-ancestors 'none'; upgrade-insecure-requests" />
  <meta name="referrer" content="no-referrer" />
  <title data-ar="التسجيل الموحد لمدارس المخا" data-en="Mokha Schools Unified Sign-In">التسجيل الموحد لمدارس المخا</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" xintegrity="sha512-AYwRbeGvI/mmL2EdwSAVPiNPOz2sVdYWW3A/rqI/CKcW/rO3rd1f5VjNstSg-zG7w4L5y+o2XpZ0bS+2c5a/FQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800;900&display=swap" rel="stylesheet">

  <link rel="icon" href="Gemini_Generated_Image_677g6v677g6v677g.png" type="image/png" />

  <!-- Custom Styles -->
  <style>
    body {
      font-family: 'Cairo', sans-serif;
      background-image: url('Gemini_Generated_Image_677g6v677g6v677g.png');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
    }

    /* Glassmorphism effect class */
    .glass-card {
      background: rgba(0, 0, 0, 0.4);
      -webkit-backdrop-filter: blur(15px);
      backdrop-filter: blur(15px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    /* Custom input focus styles */
    .form-input:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.4); /* Tailwind's blue-500 with opacity */
      border-color: #3B82F6; /* Tailwind's blue-500 */
    }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

  <div class="glass-card rounded-2xl shadow-2xl p-6 sm:p-8 max-w-md w-full text-white relative">
    <button id="langToggle" type="button" class="absolute top-4 right-4 bg-white/10 hover:bg-white/20 text-white font-bold py-1 px-3 rounded-full text-sm transition-colors duration-300">EN</button>
    
    <div class="text-center">
      <img src="Gemini_Generated_Image_677g6v677g6v677g.png" alt="شعار مدارس المخا" class="w-24 h-24 mx-auto rounded-full border-4 border-white/20 shadow-lg object-cover">
      <h1 id="loginTitle" data-ar="التسجيل الموحد لمدارس المخا" data-en="Unified Sign‑In – Mokha Schools" class="text-2xl sm:text-3xl font-bold mt-4">التسجيل الموحد لمدارس المخا</h1>
      <p class="lead text-gray-300 mt-2 text-sm" data-ar="أدخل بيانات المدرسة للوصول إلى لوحة الإدارة" data-en="Enter your school credentials to access the admin panel">أدخل بيانات المدرسة للوصول إلى لوحة الإدارة</p>
    </div>

    <form id="loginForm" autocomplete="on" class="mt-8 space-y-5">
      
      <div>
        <label for="username" class="text-sm font-medium text-gray-200 flex items-center gap-2 mb-2"><i class="fas fa-user w-4"></i><span data-ar="اسم المستخدم" data-en="Username">اسم المستخدم</span></label>
        <div class="relative">
          <input id="username" name="username" type="text" inputmode="latin" autocomplete="username" required placeholder="school01" aria-required="true" class="form-input w-full bg-black/20 border-2 border-transparent rounded-lg px-4 py-2.5 text-white placeholder-gray-400 transition" />
        </div>
      </div>

      <div>
        <label for="password" class="text-sm font-medium text-gray-200 flex items-center gap-2 mb-2"><i class="fas fa-key w-4"></i><span data-ar="كلمة المرور" data-en="Password">كلمة المرور</span></label>
        <div class="relative">
          <input id="password" name="password" type="password" autocomplete="current-password" required aria-required="true" class="form-input w-full bg-black/20 border-2 border-transparent rounded-lg px-4 py-2.5 text-white placeholder-gray-400 transition" />
          <button type="button" class="toggle-pass absolute inset-y-0 right-0 px-3 flex items-center text-gray-400 hover:text-white" aria-label="Toggle password" title="عرض/إخفاء"><i class="fa-regular fa-eye"></i></button>
        </div>
      </div>
      
      <div class="flex items-center justify-between">
          <label for="rememberMe" class="flex items-center text-sm cursor-pointer"><input id="rememberMe" type="checkbox" class="h-4 w-4 rounded bg-white/20 border-gray-500 text-blue-500 focus:ring-blue-500" /> <span data-ar="تذكرني على هذا الجهاز" data-en="Remember me on this device" class="ml-2 text-gray-300">تذكرني على هذا الجهاز</span></label>
      </div>

      <button class="btn w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-all duration-300 transform hover:scale-105 shadow-lg flex items-center justify-center gap-2 text-base" type="submit">
        <i class="fas fa-door-open"></i>
        <span data-ar="تسجيل الدخول" data-en="Sign in">تسجيل الدخول</span>
      </button>

      <div id="loading" class="hidden text-center text-blue-300" data-ar="جاري التحقق..." data-en="Validating...">جاري التحقق...</div>
      <div id="errorBox" class="hidden p-3 bg-red-500/50 border border-red-700 text-white text-center rounded-lg" role="alert"></div>

      <div class="meta text-center text-xs text-gray-400 pt-4 flex items-center justify-center gap-2">
        <i class="fa-solid fa-shield-halved text-green-400"></i>
        <span data-ar="أمان مع تشفير وتجزيء محلي" data-en="Local salted+peppered verification">أمان مع تشفير وتجزيء محلي</span>
      </div>

    </form>
    
    <div class="footer-note text-center text-xs text-gray-500 mt-6" data-ar="© منصة مدارس المخا - جميع الحقوق محفوظة" data-en="© Mokha Schools Platform - All rights reserved">© منصة مدارس المخا - جميع الحقوق محفوظة</div>
  </div>

  <script>
    // --- Language toggle ---
    let currentLanguage = localStorage.getItem('uiLang') || 'ar';
    function updateLang(){
      document.documentElement.lang = currentLanguage==='ar'?'ar':'en';
      document.documentElement.dir = currentLanguage==='ar'?'rtl':'ltr';
      document.querySelectorAll('[data-ar]').forEach(el=>{
        const ar=el.getAttribute('data-ar'); const en=el.getAttribute('data-en');
        if(ar || en) el.textContent = currentLanguage==='ar'? (ar||'') : (en||'');
      });
      document.getElementById('langToggle').textContent = currentLanguage==='ar'? 'EN':'AR';
    }
    function toggleLanguage(){ currentLanguage = currentLanguage==='ar'?'en':'ar'; localStorage.setItem('uiLang', currentLanguage); updateLang(); }
    document.getElementById('langToggle').addEventListener('click', toggleLanguage);
    updateLang();

    // --- Security helpers ---
    const txtEnc = new TextEncoder();
    async function sha256Hex(str){
      const buf = txtEnc.encode(str);
      const hash = await crypto.subtle.digest('SHA-256', buf);
      const view = new Uint8Array(hash);
      return Array.from(view).map(b=>b.toString(16).padStart(2,'0')).join('');
    }
    function b64dec(b){ try{ return atob(b); }catch{ return ''; } }
    function constCompareHex(a,b){
      if(typeof a!== 'string' || typeof b!=='string') return false;
      if(a.length !== b.length) return false;
      let out = 0; for(let i=0;i<a.length;i++){ out |= a.charCodeAt(i) ^ b.charCodeAt(i); }
      return out === 0;
    }

    // Mild pepper/secret obfuscation split & join
    const __pep = ['mo','kha','.sc','hools','.v','1'];
    const PEPPER = __pep.join(''); // "mokha.schools.v1"

    // Base schools mapping (user / password base64). DO NOT expose decoded values directly.
    const BASE_SCHOOL_DB = {
      s1: { friendlyName:'مدرسة الفقيد محمد عبدالله السراجي', uSalt:'a1f3c9e7b2d4', pSalt:'d2b7a9c4e6f1', userB64:'c2Nob29sMDE=', passB64:'TW9raGFAMTAx', redirect:'school-admin/index.html?sid=s1' },
      s2: { friendlyName:'مدرسة الشهيد اللقية', uSalt:'9c8b7a6d5e4f', pSalt:'f1e2d3c4b5a6', userB64:'c2Nob29sMDI=', passB64:'TW9raGFAMjAy', redirect:'school-admin/index.html?sid=s2' },
      s3: { friendlyName:'مدرسة النور بالثوباني', uSalt:'1122aabbccdd', pSalt:'ddccbbaa2211', userB64:'c2Nob29sMDM=', passB64:'TW9raGFAMzAz', redirect:'school-admin/index.html?sid=s3' }
    };
    const OVERRIDE_KEY = 'SCHOOL_DB_OVERRIDE';
    function loadOverride(){ try{ return JSON.parse(localStorage.getItem(OVERRIDE_KEY)||'{}'); }catch{ return {}; } }
    function saveOverride(obj){ try{ localStorage.setItem(OVERRIDE_KEY, JSON.stringify(obj||{})); }catch{} }
    function effectiveDb(){ return Object.assign({}, BASE_SCHOOL_DB, loadOverride()); }
    let SCHOOL_DB = effectiveDb();

    // Precompute salted+peppered hashes of the defaults at runtime
    const PREHASH = {};
    async function buildPrehash(){
      SCHOOL_DB = effectiveDb();
      for(const k of Object.keys(PREHASH)) delete PREHASH[k];
      for(const [sid, rec] of Object.entries(SCHOOL_DB)){
        try{
          const uDef = b64dec(rec.userB64);
            const pDef = b64dec(rec.passB64);
            PREHASH[sid] = {
              uHash: await sha256Hex(`${PEPPER}|${uDef}|${rec.uSalt}`),
              pHash: await sha256Hex(`${PEPPER}|${pDef}|${rec.pSalt}`)
            };
        }catch(e){ console.warn('prehash fail', sid, e); }
      }
    }
    buildPrehash();

    // --- Secure (local) password reset utility (master phrase required) ---
    const MASTER_RESET_PHRASE = 'CHANGE_ME_SECURELY';
    function randomPassword(len=12){
      const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz23456789@$!%*?&';
      let out=''; const arr=new Uint32Array(len); crypto.getRandomValues(arr);
      for(let i=0;i<len;i++){ out+=chars[arr[i]%chars.length]; }
      return out;
    }
    function toB64(str){ try{ return btoa(str); }catch{ return ''; } }
    async function resetSchoolPassword(sid){
      const over = loadOverride();
      const base = SCHOOL_DB[sid]; if(!base){ return { error:'مدرسة غير موجودة'}; }
      const newPass = randomPassword();
      const newPSalt = Array.from(crypto.getRandomValues(new Uint8Array(6))).map(b=>b.toString(16).padStart(2,'0')).join('').slice(0,12);
      over[sid] = Object.assign({}, base, { pSalt:newPSalt, passB64: toB64(newPass) });
      saveOverride(over);
      await buildPrehash();
      return { password:newPass };
    }
    function ensureAdminPanel(){
      if(document.getElementById('resetPanel')) return;
      const panel = document.createElement('div');
      panel.id='resetPanel';
      // Modernized styles for the reset panel to match the theme
      panel.innerHTML = `
        <div class='fixed inset-0 flex items-center justify-center bg-black/60 z-50 p-4' style="font-family:'Cairo', sans-serif;">
            <div class='glass-card rounded-2xl shadow-2xl p-6 sm:p-8 max-w-md w-full text-white' role='dialog' aria-modal='true'>
                <button class='absolute top-4 left-4 text-gray-300 hover:text-white text-2xl' aria-label='إغلاق' onclick='document.getElementById("resetPanel").remove()'>&times;</button>
                <h2 class='text-xl font-bold mb-4'>إعادة تعيين كلمات المرور (محلي)</h2>
                <p class='text-sm text-gray-300 mb-4'>هذه الأداة للطوارئ. يجب إدخال العبارة السرية. سيتم إنشاء كلمة مرور جديدة وإظهارها مرة واحدة فقط.</p>
                <div id='resetStep1'>
                    <label class='text-sm font-medium text-gray-200 mb-2 block'>العبارة السرية</label>
                    <input type='password' id='masterPhrase' placeholder='أدخل العبارة السرية' class='form-input w-full bg-black/20 border-2 border-transparent rounded-lg px-4 py-2.5 text-white placeholder-gray-400 transition'>
                    <button class='mt-4 w-full bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-2 rounded-lg transition-colors' onclick='__verifyPhrase()'>متابعة</button>
                    <div class='msg text-red-400 text-sm mt-2' id='rstMsg'></div>
                </div>
                <div id='resetStep2' class='hidden'>
                    <div class='space-y-3' id='schoolsList'></div>
                    <div class='msg text-green-400 text-sm mt-3 font-mono' id='rstMsg2'></div>
                </div>
            </div>
        </div>`;
      document.body.appendChild(panel);
    }
    window.__verifyPhrase = function(){
      const ph = document.getElementById('masterPhrase').value.trim();
      const msg = document.getElementById('rstMsg');
      if(ph !== MASTER_RESET_PHRASE){ msg.textContent='عبارة غير صحيحة'; return; }
      msg.textContent='';
      document.getElementById('resetStep1').style.display='none';
      const step2 = document.getElementById('resetStep2'); step2.classList.remove('hidden');
      const list = document.getElementById('schoolsList');
      list.innerHTML = Object.keys(SCHOOL_DB).map(sid=>{
        const rec = SCHOOL_DB[sid]||{};
        const name = rec.friendlyName ? ` – <span class='text-blue-300'>${rec.friendlyName}</span>` : '';
        return `<div class='flex items-center justify-between p-3 bg-white/5 rounded-lg'><span class='text-sm font-semibold'>${sid}${name}</span><button class='bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold py-1 px-3 rounded-md' onclick='__resetOne("${sid}")'>توليد كلمة جديدة</button></div>`;
      }).join('');
    };
    window.__resetOne = async function(sid){
      const out = await resetSchoolPassword(sid);
      const msg2 = document.getElementById('rstMsg2');
      if(out.error){ msg2.classList.remove('text-green-400'); msg2.classList.add('text-red-400'); msg2.textContent=out.error; return; }
      msg2.classList.add('text-green-400'); msg2.classList.remove('text-red-400');
      msg2.textContent = `(${sid}) كلمة المرور الجديدة: ${out.password}`;
      setTimeout(()=>{ msg2.textContent=''; }, 15000);
    };
    
    // Secret trigger: triple click logo
    document.querySelector('.mx-auto.rounded-full')?.addEventListener('click', (function(){ let c=0,t=0; return ()=>{ const now=Date.now(); if(now-t>800) c=0; t=now; c++; if(c>=3){ ensureAdminPanel(); c=0; } }; })());
    window.addEventListener('keydown', e=>{ if(e.ctrlKey && e.altKey && e.key.toLowerCase()==='r'){ e.preventDefault(); ensureAdminPanel(); } });


    // --- Form Logic ---
    const LOCK_KEY = 'mk_lock'; 
    function getLock(){ try{ return JSON.parse(sessionStorage.getItem(LOCK_KEY)||'{}'); }catch{ return {}; } }
    function setLock(v){ sessionStorage.setItem(LOCK_KEY, JSON.stringify(v)); }

    const form = document.getElementById('loginForm');
    const userEl = document.getElementById('username');
    const passEl = document.getElementById('password');
    const errorBox = document.getElementById('errorBox');
    const loading = document.getElementById('loading');
    const togglePassBtn = document.querySelector('.toggle-pass');
    
    togglePassBtn.addEventListener('click', ()=>{
      const t = passEl.getAttribute('type')==='password'? 'text':'password';
      passEl.setAttribute('type', t);
      togglePassBtn.innerHTML = t==='password' ? '<i class="fa-regular fa-eye">' : '<i class="fa-regular fa-eye-slash">';
    });
    passEl.addEventListener('paste', e=>e.preventDefault());

    function t(msgAr, msgEn){ return currentLanguage==='ar'? msgAr: msgEn; }

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      errorBox.classList.add('hidden');
      const now = Date.now();
      const lock = getLock();
      if(lock.until && now < lock.until){
        const waitSec = Math.ceil((lock.until - now)/1000);
        errorBox.textContent = t(`محاولات كثيرة، حاول بعد ${waitSec} ث`, `Too many attempts, retry in ${waitSec}s`);
        errorBox.classList.remove('hidden');
        return false;
      }
      const u = (userEl.value||'').trim();
      const p = (passEl.value||'').trim();
      if(!u || !p){
        errorBox.textContent = t('يرجى إدخال اسم المستخدم وكلمة المرور','Enter username and password');
        errorBox.classList.remove('hidden');
        return false;
      }
      loading.classList.remove('hidden');
      try{
        let matched = null;
        for(const [sid, rec] of Object.entries(SCHOOL_DB)){
          const [uH, pH] = await Promise.all([
            sha256Hex(`${PEPPER}|${u}|${rec.uSalt}`),
            sha256Hex(`${PEPPER}|${p}|${rec.pSalt}`)
          ]);
          const PH = PREHASH[sid];
          if(PH && constCompareHex(uH, PH.uHash) && constCompareHex(pH, PH.pHash)){
            matched = { sid, redirect: rec.redirect };
            break;
          }
        }
        if(!matched){
          const fails = (lock.fails||0)+1;
          const backoff = Math.min(60000, Math.pow(2, Math.min(6, fails)) * 250);
          const until = Date.now() + (fails>=5 ? backoff : 0);
          setLock({ fails, until });
          errorBox.textContent = t('بيانات الدخول غير صحيحة','Invalid credentials');
          errorBox.classList.remove('hidden');
          return false;
        }
        
        const token = Array.from(crypto.getRandomValues(new Uint8Array(24))).map(b=>b.toString(16).padStart(2,'0')).join('');
        sessionStorage.setItem('authToken', token);
        sessionStorage.setItem('userType', 'school');
        sessionStorage.setItem('schoolId', matched.sid);
        sessionStorage.setItem('loginTs', String(Date.now()));
        try {
          const rec = SCHOOL_DB[matched.sid]||{};
          localStorage.setItem('currentUser', JSON.stringify({ id: 'school:'+matched.sid, school_id: matched.sid, school_name: rec.friendlyName || matched.sid, role: 'school-admin' }));
        } catch(_){}
        
        try{
          const remember = document.getElementById('rememberMe')?.checked;
          if(remember){
            localStorage.setItem('remember:school:username', userEl.value.trim());
            if('credentials' in navigator){
              try{
                const cred = await navigator.credentials.create({ password: { id: userEl.value.trim(), password: passEl.value } });
                if(cred) await navigator.credentials.store(cred);
              }catch{}
            }
          } else {
            localStorage.removeItem('remember:school:username');
          }
        }catch{}
        setLock({ fails:0, until:0 });
        window.location.href = matched.redirect;
      } catch(err){
        console.error('login error', err);
        errorBox.textContent = t('حدث خطأ غير متوقع','Unexpected error');
        errorBox.classList.remove('hidden');
      } finally {
        loading.classList.add('hidden');
      }
      return false;
    });

    // If already logged in, fast redirect
    (function(){
      try{
        const t = sessionStorage.getItem('authToken');
        const sid = sessionStorage.getItem('schoolId');
        if(t && sid && SCHOOL_DB[sid]){
          window.location.replace(SCHOOL_DB[sid].redirect);
        }
      }catch{}
    })();
    // Prefill remembered username if available
    (function(){
      try{
        const saved = localStorage.getItem('remember:school:username');
        if(saved){
          const el = document.getElementById('username');
          const chk = document.getElementById('rememberMe');
          if(el) el.value = saved;
          if(chk) chk.checked = true;
        }
      }catch{}
    })();
  </script>
</body>
</html>
