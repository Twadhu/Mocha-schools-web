<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <link rel="stylesheet" href="css/site.css">
  <link rel="stylesheet" href="css/teacher-portal.css">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ุจูุงุจุฉ ุงููุนูู</title>
</head>
<body>
  <div id="profileModal" class="modal-overlay">
    <div class="modal-box">
      <button onclick="closeProfile()" class="modal-close">&times;</button>
  <h2 class="text-center profile-title">ุงูููู ุงูุดุฎุตู</h2>
      <form id="profileForm" enctype="multipart/form-data">
  <div class="text-center mb-16">
          <img id="profilePic" src="https://ui-avatars.com/api/?name=Teacher" alt="ุงูุตูุฑุฉ ุงูุดุฎุตูุฉ" class="profile-avatar">
          <br>
          <label for="profilePicInput" class="sr-only">ุงุฎุชุฑ ุตูุฑุฉ ุงูููู ุงูุดุฎุตู</label>
          <input type="file" id="profilePicInput" accept="image/*" class="block" title="ุงุฎุชุฑ ุตูุฑุฉ ุงูููู ุงูุดุฎุตู">
        </div>
        <label for="profileName">ุงูุงุณู ุงููุงูู</label>
        <input type="text" id="profileName" required class="block" placeholder="ุงูุชุจ ุงุณูู ุงููุงูู" title="ุงูุงุณู ุงููุงูู">
        <label for="profileEmail">ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</label>
        <input type="email" id="profileEmail" required class="block" placeholder="example@mail.com" title="ุงูุจุฑูุฏ ุงูุฅููุชุฑููู">
        <label for="profilePhone">ุฑูู ุงูุฌูุงู</label>
        <input type="text" id="profilePhone" class="block" placeholder="05xxxxxxxx" title="ุฑูู ุงูุฌูุงู">
        <button type="submit" class="btn-primary">ุญูุธ ุงูุชุนุฏููุงุช</button>
        <div id="profileMsg" class="note-sm"></div>
      </form>
    </div>
  </div>
  <div id="notificationsBar" class="notify-bar">
    <span id="notificationMsg"><i class="fas fa-bell"></i> ูุง ุชูุฌุฏ ุฅุดุนุงุฑุงุช ุญุงููุงู</span>
    <button onclick="closeNotification()" class="btn-icon">&times;</button>
  </div>
  <nav class="sidebar">
  <a href="#" onclick="openProfile()" class="profile-link">๐ค ุงูููู ุงูุดุฎุตู</a>
    <div class="logo">๐งโ๐ซ ุงููุนูู</div>
    <div class="sidebar-nav">
      <a href="#" onclick="scrollToSection('main')"><i class="fas fa-home"></i>ุงูุฑุฆูุณูุฉ</a>
      <a href="#" onclick="scrollToSection('homeworkForm')"><i class="fas fa-book"></i>ุฅุถุงูุฉ ูุงุฌุจ</a>
      <a href="#" onclick="scrollToSection('examForm')"><i class="fas fa-file-alt"></i>ุฅุถุงูุฉ ุงุฎุชุจุงุฑ</a>
      <a href="#" onclick="scrollToSection('studentsList')"><i class="fas fa-user-graduate"></i>ุฅุฏุฎุงู ุงูุฏุฑุฌุงุช</a>
      <a href="#" onclick="scrollToSection('homeworkList')"><i class="fas fa-tasks"></i>ุงููุงุฌุจุงุช</a>
      <a href="#" onclick="scrollToSection('examsList')"><i class="fas fa-clipboard-list"></i>ุงูุงุฎุชุจุงุฑุงุช</a>
      <a href="#" onclick="scrollToSection('teacherSchedule')"><i class="fas fa-calendar-alt"></i>ุฌุฏูู ุงูุญุตุต</a>
      <a href="#" onclick="scrollToSection('attendanceList')"><i class="fas fa-user-check"></i>ุงูุญุถูุฑ</a>
  <a href="#" onclick="scrollToSection('messageCenter')"><i class="fas fa-envelope"></i>ุงูุฑุณุงุฆู</a>
  <a href="#" onclick="scrollToSection('filesCenter')"><i class="fas fa-folder-open"></i>ุงููููุงุช</a>
  <a href="#" onclick="scrollToSection('dataFilters')"><i class="fas fa-filter"></i>ุงูููุงุชุฑ</a>
    </div>
    <div class="sidebar-bottom">
      <button class="dark-toggle" onclick="toggleDarkMode()"><i class="fas fa-moon"></i>ูุถุน ูููู</button>
  <a href="mocha-schools.html" class="home-link"><i class="fas fa-arrow-right"></i>ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ</a>
    </div>
  </nav>
  <div class="main-content" id="main">
  <header>
    <div class="container header-container">
      <h1>ุจูุงุจุฉ ุงููุนูู</h1>
      <div class="tools">
        <button class="btn btn-primary" onclick="downloadSchedule()">๐ ุฌุฏูู PDF</button>
        <button class="btn btn-primary" onclick="downloadIdCard()">๐ชช ุจุทุงูุฉ</button>
        <button class="btn btn-primary" onclick="loadLists()">๐ ุชุญุฏูุซ</button>
      </div>
      <div id="teacherName"></div>
    </div>
  </header>

  <main class="container">
    <!-- ูุฑูุฒ ุงูุฑุณุงุฆู -->
    <div class="card" id="messageCenter">
      <div class="section-header"><h2>ุงูุฑุณุงุฆู ุงูุฏุงุฎููุฉ</h2><span class="badge">ุชุฌุฑูุจู</span></div>
      <form id="messageForm" class="toolbar-mini">
        <input id="msgTo" placeholder="ุฅูู (ุจุฑูุฏ)" required class="flex-1 min-140">
        <input id="msgSubject" placeholder="ุงูููุถูุน" required class="flex-1 min-160">
        <input id="msgBody" placeholder="ูุต ูุฎุชุตุฑ" required class="flex-2 min-200">
        <button type="submit" class="btn btn-primary">ุฅุฑุณุงู</button>
      </form>
      <div class="toolbar-mini">
        <input id="msgSearch" class="filter-input" placeholder="ุจุญุซ..." oninput="filterMessages()">
        <button type="button" class="pill-btn" onclick="clearMessages()">ูุณุญ ุงููู</button>
      </div>
      <table>
        <thead><tr><th>ุงูุชุงุฑูุฎ</th><th>ุฅูู</th><th>ุงูููุถูุน</th><th>ุงููุต</th></tr></thead>
        <tbody id="messagesTable"><tr><td colspan="4" class="muted text-center">ูุง ุฑุณุงุฆู</td></tr></tbody>
      </table>
    </div>

    <!-- ุฅุฏุงุฑุฉ ุงููููุงุช -->
    <div class="card" id="filesCenter">
      <div class="section-header"><h2>ุงููููุงุช ุงูุฏุฑุงุณูุฉ</h2><span class="badge">ุชุฌุฑูุจู</span></div>
      <form id="fileForm" class="toolbar-mini" enctype="multipart/form-data">
        <label for="fileInput" class="sr-only">ุงุฎุชุฑ ููู</label>
        <input type="file" id="fileInput" required title="ุงุฎุชุฑ ููู ููุฑูุน" aria-label="ุงุฎุชุฑ ููู">
  <input type="text" id="fileLabel" placeholder="ูุตู ูุฎุชุตุฑ" class="flex-1 min-160">
        <button type="submit" class="btn btn-primary">ุฑูุน</button>
        <button type="button" class="btn btn-outline" onclick="exportFilesCSV()">ุชุตุฏูุฑ CSV</button>
      </form>
      <ul id="fileList" class="file-list list-reset">
        <li class="muted justify-center">ูุง ูููุงุช</li>
      </ul>
    </div>

    <!-- ููุงุชุฑ ููุฌุฏุงูู ุงูููุฌูุฏุฉ -->
    <div class="card" id="dataFilters">
      <div class="section-header"><h2>ููุงุชุฑ ุณุฑูุนุฉ</h2><span class="badge">ุจุญุซ</span></div>
      <div class="toolbar-mini">
        <input id="filterHomework" class="filter-input" placeholder="ุจุญุซ ุงููุงุฌุจุงุช" oninput="filterTable('homeworkList','filterHomework')">
        <input id="filterExams" class="filter-input" placeholder="ุจุญุซ ุงูุงุฎุชุจุงุฑุงุช" oninput="filterTable('examsList','filterExams')">
        <input id="filterSchedule" class="filter-input" placeholder="ุจุญุซ ุงูุฌุฏูู" oninput="filterTable('teacherSchedule','filterSchedule')">
  <button type="button" class="btn btn-outline" onclick="exportTableCSV('homeworkList','homework.csv')">ูุงุฌุจุงุช CSV</button>
  <button type="button" class="btn btn-outline" onclick="exportTableCSV('examsList','exams.csv')">ุงุฎุชุจุงุฑุงุช CSV</button>
  <button type="button" class="btn btn-outline" onclick="exportTableCSV('teacherSchedule','schedule.csv')">ุฌุฏูู CSV</button>
      </div>
  </div>
  <div class="grid">
      <div class="card">
        <h2>ุฅุถุงูุฉ ูุงุฌุจ ููุฒูู</h2>
        <form id="homeworkForm" novalidate>
          <div>
            <label for="subject">ุงููุงุฏุฉ</label><br>
            <select id="subject" required aria-label="ุงููุงุฏุฉ"></select>
          </div>
          <div>
            <label for="class_level">ุงูุตู</label><br>
            <select id="class_level" required aria-label="ุงูุตู">
              <option value="first">ุงูุฃูู</option>
              <option value="second">ุงูุซุงูู</option>
              <option value="third">ุงูุซุงูุซ</option>
            </select>
          </div>
          <div>
            <label for="section">ุงูุดุนุจุฉ</label><br>
            <input id="section" placeholder="A/B/C" />
          </div>
          <div>
            <label for="homework_title">ุนููุงู ุงููุงุฌุจ</label><br>
            <input type="text" id="homework_title" required placeholder="ูุซุงู: ูุงุฌุจ ุงููุญุฏุฉ 2 - ุฑูุงุถูุงุช">
          </div>
          <div>
            <label for="homework_content">ุชูุงุตูู ุงููุงุฌุจ</label><br>
            <textarea id="homework_content" rows="4" required placeholder="ุงูุชุนูููุงุช..."></textarea>
          </div>
          <div>
            <label for="due_date">ููุนุฏ ุงูุชุณููู</label><br>
            <input type="date" id="due_date" required>
          </div>
          <div>
            <button type="submit" class="btn btn-primary">ุญูุธ ุงููุงุฌุจ</button>
          </div>
          <div id="homeworkMsg" class="msg"></div>
        </form>
      </div>

      <div class="card">
        <h2>ุฅุถุงูุฉ ุงุฎุชุจุงุฑ</h2>
        <form id="examForm" novalidate>
          <div>
            <label for="exam_subject">ุงููุงุฏุฉ</label><br>
            <select id="exam_subject" required aria-label="ูุงุฏุฉ ุงูุงุฎุชุจุงุฑ"></select>
          </div>
          <div>
            <label for="exam_class">ุงูุตู</label><br>
            <select id="exam_class" required aria-label="ุตู ุงูุงุฎุชุจุงุฑ">
              <option value="first">ุงูุฃูู</option>
              <option value="second">ุงูุซุงูู</option>
              <option value="third">ุงูุซุงูุซ</option>
            </select>
          </div>
          <div>
            <label for="exam_section">ุงูุดุนุจุฉ</label><br>
            <input id="exam_section" placeholder="A/B/C" />
          </div>
          <div>
            <label for="exam_title">ุนููุงู ุงูุงุฎุชุจุงุฑ</label><br>
            <input type="text" id="exam_title" required placeholder="ุงุฎุชุจุงุฑ ุดูุฑู 1">
          </div>
          <div>
            <label for="exam_duration">ูุฏุฉ ุงูุงุฎุชุจุงุฑ (ุฏูุงุฆู)</label><br>
            <input type="number" id="exam_duration" min="10" max="180" required placeholder="60">
          </div>
          <div>
            <label for="exam_date">ุชุงุฑูุฎ ุงูุงุฎุชุจุงุฑ</label><br>
            <input type="date" id="exam_date" required>
          </div>
          <div>
            <button type="submit" class="btn btn-primary">ุญูุธ ุงูุงุฎุชุจุงุฑ</button>
          </div>
          <div id="examMsg" class="msg"></div>
        </form>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>ุฅุฏุฎุงู ุงูุฏุฑุฌุงุช</h2>
        <div class="controls">
          <select id="grade_subject" aria-label="ูุงุฏุฉ ุงูุฏุฑุฌุงุช"></select>
          <select id="grade_class" aria-label="ุตู ุงูุฏุฑุฌุงุช">
            <option value="first">ุงูุฃูู</option>
            <option value="second">ุงูุซุงูู</option>
            <option value="third">ุงูุซุงูุซ</option>
            <option value="fourth">ุงูุฑุงุจุน</option>
            <option value="fifth">ุงูุฎุงูุณ</option>
            <option value="sixth">ุงูุณุงุฏุณ</option>
            <option value="seventh">ุงูุณุงุจุน</option>
            <option value="eighth">ุงูุซุงูู</option>
            <option value="ninth">ุงูุชุงุณุน</option>
            <option value="tenth">ุฃูู ุซุงููู</option>
            <option value="eleventh">ุงูุซุงูู ุซุงููู</option>
            <option value="twelfth">ุงูุซุงูุซ ุซุงููู</option>
          </select>
          <input id="grade_section" placeholder="A/B/C" />
          <select id="grade_term" aria-label="ูุตู ุงูุฏุฑุฌุงุช">
            <option value="ุงูุฃูู">ุงูุฃูู</option>
            <option value="ุงูุซุงูู">ุงูุซุงูู</option>
          </select>
          <select id="grade_month" aria-label="ุดูุฑ ุงูุฏุฑุฌุงุช">
            <option value="1">ุดูุฑ 1</option>
            <option value="2">ุดูุฑ 2</option>
            <option value="3">ุดูุฑ 3</option>
          </select>
          <button id="loadStudents" class="btn btn-primary">ุชุญููู</button>
        </div>
        <table>
          <thead><tr><th>ุงูุทุงูุจ</th><th>ุงูุจุฑูุฏ</th><th>ุงูุฏุฑุฌุฉ</th><th>ุญูุธ</th></tr></thead>
    <tbody id="studentsList"><tr><td colspan="4" class="muted text-center">ุงุฎุชุฑ ุงูุจูุงูุงุช ุซู ุชุญููู</td></tr></tbody>
        </table>
        <div id="gradeMsg" class="msg"></div>
      </div>

      <div class="card">
        <h2>ุงููุงุฌุจุงุช ู ุงูุงุฎุชุจุงุฑุงุช</h2>
        <h3 class="card-subtitle">ุงููุงุฌุจุงุช</h3>
        <table>
          <thead><tr><th>ุงููุงุฏุฉ</th><th>ุงูุนููุงู</th><th>ุงูุชุณููู</th><th>ุงูุตู</th><th>ุงูุดุนุจุฉ</th></tr></thead>
          <tbody id="homeworkList"><tr><td colspan="5" class="muted text-center">ูุง ุจูุงูุงุช</td></tr></tbody>
        </table>
        <h3 class="card-subtitle-spaced">ุงูุงุฎุชุจุงุฑุงุช</h3>
        <table>
          <thead><tr><th>ุงููุงุฏุฉ</th><th>ุงูุนููุงู</th><th>ุงูุชุงุฑูุฎ</th><th>ุงููุฏุฉ</th><th>ุงูุตู</th><th>ุงูุดุนุจุฉ</th></tr></thead>
          <tbody id="examsList"><tr><td colspan="6" class="muted text-center">ูุง ุจูุงูุงุช</td></tr></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <h2>ุฌุฏูู ุงูุญุตุต</h2>
      <div class="schedule-controls">
        <label>ุงููุตู:</label>
        <select id="teacherSemester" aria-label="ุงููุตู ุงูุฏุฑุงุณู ููุฌุฏูู"><option value="">ุงููู</option><option value="1">ุงูุฃูู</option><option value="2">ุงูุซุงูู</option></select>
  <button onclick="loadTeacherSchedule()" class="btn btn-primary">ุชุญููู</button>
      </div>
      <table>
        <thead><tr><th>ุงููุตู</th><th>ุงูุตู</th><th>ุงูููู</th><th>ุงูุญุตุฉ</th><th>ุงููุงุฏุฉ</th></tr></thead>
        <tbody id="teacherSchedule"><tr><td colspan="5" class="muted text-center">โ</td></tr></tbody>
      </table>
    </div>

    <div class="card">
      <h2>ุงูุญุถูุฑ ุงููููู</h2>
      <div class="controls">
        <select id="att_class" aria-label="ุตู ุงูุญุถูุฑ">
          <option value="first">ุงูุฃูู</option><option value="second">ุงูุซุงูู</option><option value="third">ุงูุซุงูุซ</option>
        </select>
        <input id="att_section" placeholder="A/B/C" aria-label="ุดุนุจุฉ" />
  <button id="loadAttStudents" class="btn btn-primary">ุชุญููู ุงูุทูุงุจ</button>
  <button id="markAllPresent" class="btn">ุงููู ุญุงุถุฑ</button>
        <input type="date" id="attFromT" aria-label="ูู" />
        <input type="date" id="attToT" aria-label="ุฅูู" />
  <button id="downloadAttPdf" class="btn btn-outline">ุชูุฑูุฑ PDF</button>
      </div>
      <table>
        <thead><tr><th>ุงูุทุงูุจ</th><th>ุงูุญุงูุฉ</th><th>ุญูุธ</th></tr></thead>
        <tbody id="attendanceList"><tr><td colspan="3" class="muted text-center">โ</td></tr></tbody>
      </table>
      <div id="attendanceMsg" class="msg hidden"></div>
    </div>
  </main>

  <script>
    function buildApiUrl(path){
      path = path.replace(/^\/+/, '');
      const href = location.pathname; const marker='front-mocha-schools-website'; let basePrefix='../';
      if(href.includes(marker)){
        const after = href.split(marker)[1] || ''; const extra=after.split('/').filter(s=>s.length>0 && s.indexOf('.')===-1); basePrefix='../'.repeat(1+extra.length);
      }
      return basePrefix + path;
    }
    async function apiFetch(path, options={}){
      const res = await fetch(buildApiUrl(path), options);
      if(res.status===401){ location='teacher-login.html?expired=1'; throw new Error('EXPIRED'); }
      return res;
    }
    function auth(){ return { 'Authorization':'Bearer '+localStorage.getItem('authToken'), 'Content-Type':'application/json' }; }
  function fillSubjects(selectIds){ apiFetch('api/subjects.php',{headers:{'Authorization':'Bearer '+localStorage.getItem('authToken')}}).then(r=>r.json()).then(d=>{ if(d.ok){ selectIds.forEach(id=>{ const sel=document.getElementById(id); sel.innerHTML = d.subjects.map(s=>`<option value="${s.name}">${s.name}</option>`).join(''); }); }}); }
    document.addEventListener('DOMContentLoaded', ()=>{
      const user=JSON.parse(localStorage.getItem('currentUser'));
      if(!user){ location='teacher-login.html'; return; }
      document.getElementById('teacherName').textContent = (user.first_name||'')+' '+(user.last_name||'');
      fillSubjects(['subject','exam_subject','grade_subject']);
      loadLists();
      // restore dark mode if previously set
      if(localStorage.getItem('darkMode')==='1'){
        document.body.classList.add('dark-mode');
      }
    });

    async function loadLists(){ loadHomework(); loadExams(); }
  async function loadHomework(){ try{ const r=await apiFetch('api/teacher.php?path=homework',{headers:auth()}); const d=await r.json(); const tb=document.getElementById('homeworkList'); if(!d.ok||!d.items.length){ tb.innerHTML='<tr><td colspan="5" class="muted text-center">ูุง ุจูุงูุงุช</td></tr>'; return;} tb.innerHTML=d.items.map(i=>`<tr><td>${i.subject}</td><td>${i.title}</td><td>${i.due_date}</td><td>${i.class_level}</td><td>${i.section||''}</td></tr>`).join(''); }catch{}}
  async function loadExams(){ try{ const r=await apiFetch('api/teacher.php?path=exams',{headers:auth()}); const d=await r.json(); const tb=document.getElementById('examsList'); if(!d.ok||!d.items.length){ tb.innerHTML='<tr><td colspan="6" class="muted text-center">ูุง ุจูุงูุงุช</td></tr>'; return;} tb.innerHTML=d.items.map(i=>`<tr><td>${i.subject}</td><td>${i.title}</td><td>${i.exam_date}</td><td>${i.duration}ุฏ</td><td>${i.class_level}</td><td>${i.section||''}</td></tr>`).join(''); }catch{}}

    // ุญูุธ ูุงุฌุจ
  document.getElementById('homeworkForm').addEventListener('submit', async e=>{ e.preventDefault(); const msg=document.getElementById('homeworkMsg'); msg.style.display='none'; const payload={ subject:subject.value, class_level:class_level.value, section:section.value.trim(), title:homework_title.value.trim(), content:homework_content.value.trim(), due_date:due_date.value }; if(!payload.subject||!payload.class_level||!payload.title||!payload.content||!payload.due_date){ msg.textContent='ุงููู ุงูุญููู'; msg.className='msg error'; msg.style.display='block'; return;} try{ const r=await apiFetch('api/teacher.php?path=homework',{method:'POST',headers:auth(),body:JSON.stringify(payload)}); const d=await r.json(); if(!d.ok){ throw 0;} msg.textContent='ุชู ุงูุญูุธ'; msg.className='msg ok'; msg.style.display='block'; e.target.reset(); loadHomework(); }catch{ msg.textContent='ูุดู'; msg.className='msg error'; msg.style.display='block'; }});

    // ุญูุธ ุงุฎุชุจุงุฑ
  document.getElementById('examForm').addEventListener('submit', async e=>{ e.preventDefault(); const msg=document.getElementById('examMsg'); msg.style.display='none'; const payload={ subject:exam_subject.value, class_level:exam_class.value, section:exam_section.value.trim(), title:exam_title.value.trim(), duration:Number(exam_duration.value), exam_date:exam_date.value }; if(!payload.subject||!payload.class_level||!payload.title||!payload.duration||!payload.exam_date){ msg.textContent='ุงููู ุงูุญููู'; msg.className='msg error'; msg.style.display='block'; return;} try{ const r=await apiFetch('api/teacher.php?path=exam',{method:'POST',headers:auth(),body:JSON.stringify(payload)}); const d=await r.json(); if(!d.ok){ throw 0;} msg.textContent='ุชู ุงูุญูุธ'; msg.className='msg ok'; msg.style.display='block'; e.target.reset(); loadExams(); }catch{ msg.textContent='ูุดู'; msg.className='msg error'; msg.style.display='block'; }});

    // ุชุญููู ุทูุงุจ ุงูุฏุฑุฌุงุช
  document.getElementById('loadStudents').addEventListener('click', async ()=>{ const subject=grade_subject.value; const grade=grade_class.value; const sec=grade_section.value.trim(); if(!subject||!grade||!sec){ gradeMsg.textContent='ุฃููู ุงูุจูุงูุงุช'; gradeMsg.className='msg error'; gradeMsg.style.display='block'; return;} const tb=studentsList; tb.innerHTML='<tr><td colspan="4" class="muted text-center">ุชุญููู...</td></tr>'; try{ const r=await apiFetch(`api/teacher.php?path=students&class=${encodeURIComponent(grade)}&section=${encodeURIComponent(sec)}`,{headers:auth()}); const d=await r.json(); if(!d.ok||!d.data?.length){ tb.innerHTML='<tr><td colspan="4" class="muted text-center">ูุง ุทูุงุจ</td></tr>'; return;} tb.innerHTML=d.data.map(st=>`<tr><td>${st.full_name}</td><td>${st.email}</td><td><input type='number' min='0' max='100' step='0.1' data-email='${st.email}' class='w-80'/></td><td><button class="btn btn-primary" onclick="saveGrade('${st.email}')">ุญูุธ</button></td></tr>`).join(''); }catch{ tb.innerHTML='<tr><td colspan="4" class="muted text-center">ุฎุทุฃ</td></tr>'; }});

  window.saveGrade = async (email)=>{ const subject=grade_subject.value; const term=grade_term.value; const month=grade_month.value; const inp=document.querySelector(`input[data-email='${email}']`); const grade=inp.value; if(!subject||!term||!month||!grade){ gradeMsg.textContent='ุฃููู ุงูุญููู'; gradeMsg.className='msg error'; gradeMsg.style.display='block'; return;} try{ const r=await apiFetch('api/teacher.php?path=grade',{method:'POST',headers:auth(),body:JSON.stringify({ email, subject, term, month:Number(month), grade:Number(grade) })}); const d=await r.json(); if(!d.ok) throw 0; gradeMsg.textContent='ุชู ุงูุญูุธ'; gradeMsg.className='msg ok'; gradeMsg.style.display='block'; inp.value=''; }catch{ gradeMsg.textContent='ูุดู'; gradeMsg.className='msg error'; gradeMsg.style.display='block'; }};

  async function loadTeacherSchedule(){ const sem=teacherSemester.value; const qs= sem?`&semester=${sem}`:''; const tb=document.getElementById('teacherSchedule'); tb.innerHTML='<tr><td colspan="5" class="muted text-center">ุชุญููู...</td></tr>'; try{ const r=await apiFetch('api/teacher.php?path=schedule'+qs,{headers:auth()}); const d=await r.json(); if(!d.ok||!d.items.length){ tb.innerHTML='<tr><td colspan="5" class="muted text-center">ูุง ุจูุงูุงุช</td></tr>'; return;} tb.innerHTML=d.items.map(i=>`<tr><td>${i.semester||''}</td><td>${i.grade||''}</td><td>${i.day}</td><td>${i.period}</td><td>${i.subject}</td></tr>`).join(''); }catch{ tb.innerHTML='<tr><td colspan="5" class="muted text-center">ุฎุทุฃ</td></tr>'; }}

  function downloadSchedule(){ window.open(buildApiUrl('api/teacher.php?path=schedule/print'),'_blank'); }
  function downloadIdCard(){ window.open(buildApiUrl('api/teacher.php?path=id-card'),'_blank'); }

  // Smooth scroll to sections
  function scrollToSection(id){ const el=document.getElementById(id); if(el){ el.scrollIntoView({behavior:'smooth', block:'start'}); } }

  // Profile modal helpers
  function openProfile(){ const m=document.getElementById('profileModal'); if(m){ m.style.display='flex'; } }
  function closeProfile(){ const m=document.getElementById('profileModal'); if(m){ m.style.display='none'; } }
  (function(){ const m=document.getElementById('profileModal'); if(m){ m.addEventListener('click', (e)=>{ if(e.target.id==='profileModal'){ closeProfile(); } }); }} )();
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ closeProfile(); }});

  // Notifications bar and toast
  function closeNotification(){ const bar=document.getElementById('notificationsBar'); if(!bar) return; bar.style.top='-60px'; setTimeout(()=>{ bar.style.display='none'; },300); }
  function showToast(text, type='info'){
    const bar=document.getElementById('notificationsBar'); const msg=document.getElementById('notificationMsg');
    if(!bar||!msg) return;
    msg.innerHTML = (type==='ok'?'โ ':'โน๏ธ ')+text;
    bar.style.display='flex'; bar.style.top='0';
    clearTimeout(window.__toastT);
    window.__toastT = setTimeout(()=>{ closeNotification(); }, 3000);
  }

  // Dark mode toggle
  function toggleDarkMode(){ const b=document.body; b.classList.toggle('dark-mode'); localStorage.setItem('darkMode', b.classList.contains('dark-mode')?'1':'0'); }

  // Generic table filter (client-side)
  function filterTable(tableId, inputId){ const input=document.getElementById(inputId); const tb=document.getElementById(tableId); if(!input||!tb) return; const q=(input.value||'').toLowerCase(); Array.from(tb.querySelectorAll('tr')).forEach(tr=>{ if(tr.querySelector('td')){ tr.style.display = tr.textContent.toLowerCase().includes(q)?'':'none'; } }); }

  // CSV exports
  function exportTableCSV(tableId, filename){ const table = document.getElementById(tableId)?.closest('table'); if(!table) return; const rows = Array.from(table.querySelectorAll('tr')).map(tr=> Array.from(tr.children).map(td=> '"'+(td.textContent||'').replace(/"/g,'""')+'"').join(',')); const blob = new Blob([rows.join('\n')], {type:'text/csv;charset=utf-8;'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename||'export.csv'; a.click(); URL.revokeObjectURL(a.href); }
  function exportFilesCSV(){ const items = Array.from(document.querySelectorAll('#fileList li span:first-child')).map(s=> s.textContent.trim()); if(!items.length){ showToast('ูุง ุชูุฌุฏ ูููุงุช ููุชุตุฏูุฑ'); return; } const blob = new Blob([items.map(t=>'"'+t.replace(/"/g,'""')+'"').join('\n')], {type:'text/csv;charset=utf-8;'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='files.csv'; a.click(); URL.revokeObjectURL(a.href); }

  // Messages center (local demo)
  const __messages = [];
  document.getElementById('messageForm').addEventListener('submit', (e)=>{
    e.preventDefault(); const to=msgTo.value.trim(); const subject=msgSubject.value.trim(); const body=msgBody.value.trim();
    if(!to||!subject||!body) return;
    __messages.unshift({ date:new Date().toLocaleString('ar-EG'), to, subject, body });
    renderMessages(); e.target.reset(); showToast('ุชู ุฅุฑุณุงู ุงูุฑุณุงูุฉ','ok');
  });
  function renderMessages(){ const tb=document.getElementById('messagesTable'); if(!tb) return; const q=(document.getElementById('msgSearch').value||'').toLowerCase(); if(!__messages.length){ tb.innerHTML='<tr><td colspan="4" class="muted text-center">ูุง ุฑุณุงุฆู</td></tr>'; return; } tb.innerHTML = __messages.filter(m=> (m.to+m.subject+m.body).toLowerCase().includes(q)).map(m=>`<tr><td>${m.date}</td><td>${m.to}</td><td>${m.subject}</td><td>${m.body}</td></tr>`).join(''); }
  function filterMessages(){ renderMessages(); }
  function clearMessages(){ __messages.length=0; renderMessages(); }

  // Files center (local demo)
  document.getElementById('fileForm').addEventListener('submit', (e)=>{
    e.preventDefault(); const file=document.getElementById('fileInput').files[0]; const label=(document.getElementById('fileLabel').value||'').trim(); if(!file) return;
    const li=document.createElement('li'); li.innerHTML = `<span>${label||file.name}</span> <span class="badge-type">${file.type||'ููู'}</span>`;
    document.getElementById('fileList').appendChild(li); e.target.reset(); showToast('ุชู ุฅุถุงูุฉ ุงูููู','ok');
  });

    const attList = document.getElementById('attendanceList');
    document.getElementById('loadAttStudents').addEventListener('click', async ()=>{
      const grade = att_class.value; const sec = att_section.value.trim();
      attList.innerHTML='<tr><td colspan="3" class="muted text-center">ุชุญููู...</td></tr>';
  try { const r= await apiFetch(`api/teacher.php?path=students&grade_level=${encodeURIComponent(grade)}&section=${encodeURIComponent(sec)}`, { headers: auth() }); const d= await r.json(); if(!d.ok||!d.students?.length){ attList.innerHTML='<tr><td colspan="3" class="muted text-center">ูุง ุทูุงุจ</td></tr>'; return; } attList.innerHTML = d.students.map(st=>`<tr data-id='${st.id}'><td>${st.full_name||st.name}</td><td><select data-status><option value='present'>ุญุงุถุฑ</option><option value='absent'>ุบุงุฆุจ</option><option value='late'>ูุชุฃุฎุฑ</option></select></td><td><button class="btn btn-primary" onclick="saveAttendance(${st.id})">ุญูุธ</button></td></tr>`).join(''); } catch { attList.innerHTML='<tr><td colspan="3" class="muted text-center">ุฎุทุฃ</td></tr>'; }
    });
    document.getElementById('markAllPresent').addEventListener('click', ()=>{ attList.querySelectorAll('select[data-status]').forEach(s=> s.value='present'); });
  window.saveAttendance = async (sid)=>{ const row = attList.querySelector(`tr[data-id='${sid}']`); const status = row.querySelector('select[data-status]').value; try { const r= await apiFetch('api/attendance.php',{ method:'POST', headers: auth(), body: JSON.stringify({ student_id:sid, status }) }); const d= await r.json(); if(d.ok){ attendanceMsg.textContent='ุชู ุงูุญูุธ'; attendanceMsg.className='msg ok'; } else { attendanceMsg.textContent='ูุดู'; attendanceMsg.className='msg error'; } } catch { attendanceMsg.textContent='ุฎุทุฃ'; attendanceMsg.className='msg error'; } attendanceMsg.style.display='block'; };

    document.getElementById('downloadAttPdf').addEventListener('click', async ()=>{
      const f=attFromT.value; const t=attToT.value; const qs=(f||t)?`&${f?`from=${encodeURIComponent(f)}`:''}${f&&t?'&':''}${t?`to=${encodeURIComponent(t)}`:''}`:'';
      const url = buildApiUrl(`api/api.php?action=attendance_report${qs}`);
      try {
        const token = localStorage.getItem('authToken');
        const res = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
        if(!res.ok) throw new Error('ุฎุทุฃ ุฃุซูุงุก ุชูููุฏ ุงูุชูุฑูุฑ');
        const blob = await res.blob();
        const dl = document.createElement('a');
        dl.href = URL.createObjectURL(blob);
        dl.download = 'attendance.csv';
        document.body.appendChild(dl); dl.click(); dl.remove();
        setTimeout(()=> URL.revokeObjectURL(dl.href), 1000);
      } catch { showToast('ูุดู ุชูุฒูู ุงูุชูุฑูุฑ','error'); }
    });
  </script>
</body>
</html>
